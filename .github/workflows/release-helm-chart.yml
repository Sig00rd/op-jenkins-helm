name: Build a Helm package and Push it to ACR

on:
  workflow_dispatch:
    inputs:
      chartVersion:
        description: "Helm chart version to release. eg. 0.1.1"
        required: true
      appVersion:
        description: "Operator app version without quotes, eg. 0.8.1 . If not provided, the one in Chart.yaml won't be overwritten."
        required: false

jobs:
  build:
    name: publish acr 
    runs-on: ubuntu-latest
    env: 
      HELM_EXPERIMENTAL_OCI: 1
    steps:
    
      - uses: actions/checkout@v2
        name: checkout repo
      
      - name: install helm
        uses: Azure/setup-helm@v1
        env:
          HELM_VERSION_TO_INSTALL: 3.6.3
        with:
          version: ${{ env.HELM_VERSION_TO_INSTALL }}
        
      - name: login to acr using helm
        env:
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
        run: |
          helm registry login operatorservice.azurecr.io -u $ACR_USERNAME -p $ACR_PASSWORD
          
      - name: Create Helm Chart package
        run: |
          if [ ${{ github.event.inputs.appVersion }} ] ; then
            make change-chart-version CHART_VERSION=${{ github.event.inputs.chartVersion }} APP_VERSION=${{ github.event.inputs.appVersion }}
          else 
            make change-chart-version CHART_VERSION=${{ github.event.inputs.chartVersion }}
          fi
          
          make helm-package-latest CHART_VERSION=${{ github.event.inputs.chartVersion }}
          
      - name: Save Charts to local helm registry
        run: | 
          make helm-save-local CHART_VERSION=${{ github.event.inputs.chartVersion }}
          
      - name: Push saved charts to ACR registry
        run: |
          helm chart push operatorservice.azurecr.io/helm/op-svc-jenkins:${{ github.event.inputs.chartVersion }}
          helm chart push operatorservice.azurecr.io/helm/op-svc-jenkins-crs:${{ github.event.inputs.chartVersion }}
          helm chart push operatorservice.azurecr.io/helm/op-svc-jenkins:latest
          helm chart push operatorservice.azurecr.io/helm/op-svc-jenkins-crs:latest
